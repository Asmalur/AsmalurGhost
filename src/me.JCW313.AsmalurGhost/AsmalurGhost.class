package me.JCW313.AsmalurGhost;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.util.logging.Logger;
import java.util.Date;
import java.text.SimpleDateFormat;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.plugin.PluginDescriptionFile;
import org.bukkit.plugin.PluginManager;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.potion.PotionEffectType;

public class AsmalurGhost extends JavaPlugin {
	public final Logger logger = Logger.getLogger("Mincecraft");
	public static AsmalurGhost plugin;
	public final PlayerJoinListener pj = new PlayerJoinListener();
	public final PlayerInteractListener pi = new PlayerInteractListener();
	
	 @Override
	    public void onDisable() {PluginDescriptionFile pdffile = this.getDescription();
	        logger.info(pdffile.getName() + " v" + pdffile.getVersion() + " is now disabled.");
	    }
	    @Override
	    public void onEnable() {PluginDescriptionFile pdffile = this.getDescription();
	        logger.info(pdffile.getName() + " v" + pdffile.getVersion() + " is now enabled!");
	            PluginManager pm = getServer().getPluginManager();
	            pm.registerEvents(this.pj, this);
	            pm.registerEvents(this.pi, this);
	            return;
	    }	
	    public void logToFile(String message)
	    {
	        try
	        {
	            File dataFolder = getDataFolder();
	            if(!dataFolder.exists())
	            {
	                dataFolder.mkdir();
	            }
	 
	            File saveTo = new File(getDataFolder(), "data.txt");
	            if (!saveTo.exists())
	            {
	                saveTo.createNewFile();
	            }
	 
	 
	            FileWriter fw = new FileWriter(saveTo, true);
	 
	            PrintWriter pw = new PrintWriter(fw);
	 
	            pw.println(message);
	 
	            pw.flush();
	 
	            pw.close();
	 
	        } catch (IOException e)
	        {
	            e.printStackTrace();
	        }
	 
	    }
	    
	    public boolean onCommand(CommandSender sender, Command cmd, String commandLabel, String[] args){
	    	if (sender instanceof Player){
	            if(commandLabel.equalsIgnoreCase("authorize")){
	            	if(sender.hasPermission("asmalurghost.authorize"))
	            		
	            		if(args.length == 0){
	            			sender.sendMessage(ChatColor.RED + "You must select a Guest!");
	            			sender.sendMessage(ChatColor.GREEN + "Correct Use: /authorize <player>");
	            			
	            		}else if(args.length == 1){
	            			if(Bukkit.getServer().getPlayer(args[0])!= null){
	            			Player target = Bukkit.getServer().getPlayer(args[0]);
	            		Bukkit.getServer().dispatchCommand(Bukkit.getConsoleSender(), "manuadd " + args[0] + " Default");
	            		Bukkit.getServer().dispatchCommand(Bukkit.getConsoleSender(), "whitelist add " + args[0]);
	            	sender.sendMessage(ChatColor.GREEN + args[0] + " Authorized!");
	            	target.sendMessage(ChatColor.GOLD + "You have been " + ChatColor.GREEN + "accepted! " + ChatColor.GOLD + " Welcome to Asmalur!");
	            	Bukkit.getServer().dispatchCommand(Bukkit.getConsoleSender(), "spawn " + args[0]);
	            	target.setGameMode(GameMode.SURVIVAL);
	    			target.removePotionEffect(PotionEffectType.INVISIBILITY);
	    			for(Player player : Bukkit.getOnlinePlayers()) {
	    				player.showPlayer(target);
	    			}
	    			
	            			}else{
	            				sender.sendMessage(ChatColor.WHITE + "Guest was moved to Default while offline.");
	            			}
	    				    				
	            	        java.util.Date now = new Date();
	            	        SimpleDateFormat format = new SimpleDateFormat("dd-MM-yyyy HH:mm:ss");
	    	            	System.out.println("Time: "+format.format(now));
	    	            	     logToFile("["  + now + "] " + sender.getName() + " authorized " + args[0] + " to the Default group.");
	    	             		}
	            }
	    	}
	    	return false;
	    }
}
